# Webhook API

详细的 Webhook API 文档。

## 端点地址

默认端口：`18010`

可以在"设置" -> "高级设置"中修改端口。

## 支持的录播软件

### B站录播姬

**地址**：`http://127.0.0.1:18010/webhook/bililiverecorder`

**方法**：`POST`

**说明**：需要在软件中设置"录播姬工作目录"

### blrec

**地址**：`http://127.0.0.1:18010/webhook/blrec`

**方法**：`POST`

**说明**：需要启用"视频文件创建"和"视频文件完成"两个事件

### DDTV

**地址**：`http://127.0.0.1:18010/webhook/ddtv`

**方法**：`POST`

**说明**：需要设置绝对路径的录制文件保存路径

### oneliverec

**地址**：`http://127.0.0.1:18010/webhook/oneliverec`

**方法**：`POST`

**说明**：需要启用"格式转换"和"视频转换完成"事件

## 自定义 Webhook

### 基本信息

**地址**：`http://127.0.0.1:18010/webhook/custom`

**方法**：`POST`

**Content-Type**：`application/json`

**响应**：立即返回 HTTP 200

### 请求参数

#### 必需参数

| 参数       | 类型   | 说明               | 示例                      |
| ---------- | ------ | ------------------ | ------------------------- |
| `event`    | string | 事件类型           | `FileClosed`              |
| `filePath` | string | 视频文件的绝对路径 | `D:\\video\\stream.mp4`   |
| `roomId`   | number | 房间号             | `93589`                   |
| `time`     | string | 直播开始时间       | `2021-05-14T17:52:54.946` |
| `title`    | string | 直播标题           | `今天打游戏`              |
| `username` | string | 主播名称           | `主播名`                  |

#### 可选参数

| 参数              | 类型   | 说明         | 示例                      |
| ----------------- | ------ | ------------ | ------------------------- |
| `coverPath`       | string | 封面文件路径 | `D:\\video\\stream.jpg`   |
| `danmuPath`       | string | 弹幕文件路径 | `D:\\video\\stream.xml`   |
| `platform`        | string | 平台名称     | `bilibili` / `douyu`      |
| `live_start_time` | string | 直播开始时间 | `2021-05-14T17:52:54.946` |
| `live_title`      | string | 直播标题     | `直播标题`                |

::: tip 提示
如果不提供 `coverPath`，会自动查找同名的 jpg 文件。
如果不提供 `danmuPath`，会自动查找同名的 xml 文件。
:::

### 事件类型

| 事件          | 说明         | 用途                 |
| ------------- | ------------ | -------------------- |
| `FileClosed`  | 文件录制完成 | 正常处理流程         |
| `FileOpening` | 文件开始录制 | 用于断播续传         |
| `FileError`   | 文件错误     | 标记为错误，避免阻塞 |

### 断播续传

如果需要使用断播续传功能：

1. 第一个文件录制完成时发送 `FileClosed` 事件
2. 第二个文件开始录制时发送 `FileOpening` 事件
3. 如果两个事件的时间间隔小于配置的"续传时间间隔"，会被识别为同一场直播
4. 第二个文件录制完成时发送 `FileClosed` 事件

### 弹幕分析

如果需要使用弹幕分析功能，建议提供以下参数：

- `platform`: 平台名称（推荐 `bilibili` 或 `douyu`）
- `live_start_time`: 直播开始时间
- `live_title`: 直播标题

::: tip 元数据
如果弹幕文件中包含元数据（如 blrec、douyu-cli 0.6.1+ 生成的弹幕），会自动解析，无需手动提供。
:::

### 请求示例

```bash
curl --location 'http://127.0.0.1:18010/webhook/custom' \
--header 'Content-Type: application/json' \
--data '{
    "event": "FileClosed",
    "filePath": "D:\\video\\stream.mp4",
    "coverPath": "D:\\video\\stream.jpg",
    "danmuPath": "D:\\video\\stream.xml",
    "roomId": 93589,
    "time": "2021-05-14T17:52:54.946",
    "title": "今天打游戏",
    "username": "主播名",
    "platform": "bilibili",
    "live_start_time": "2021-05-14T17:52:54.946",
    "live_title": "直播标题"
}'
```

### 响应示例

**成功**

```json
{
  "code": 0,
  "message": "success"
}
```

**失败**

```json
{
  "code": -1,
  "message": "error message"
}
```

## 处理流程

### 完整流程

```
Webhook接收
    ↓
参数验证
    ↓
查找配置（根据roomId）
    ↓
加入处理队列
    ↓
按配置处理
    ↓
1. FLV修复（如果启用）
2. 转封装（如果启用）
3. 弹幕转换（如果启用）
4. 高能进度条（如果启用）
5. 弹幕压制（如果启用）
6. 视频处理（如果启用）
    ↓
上传到B站（如果启用）
    ↓
同步到云盘（如果启用）
    ↓
发送通知（如果启用）
    ↓
完成
```

### 断播续传流程

```
第一个文件 FileClosed
    ↓
第二个文件 FileOpening（时间间隔 < 配置值）
    ↓
识别为续传，等待
    ↓
第二个文件 FileClosed
    ↓
继续等待（时间间隔）
    ↓
超时或收到新的 FileOpening
    ↓
合并所有文件
    ↓
继续处理流程
```

## 配置查找

### 查找顺序

1. 查找与 `roomId` 完全匹配的配置
2. 如果没有找到，使用全局默认配置
3. 如果全局配置未启用，跳过处理

### 配置优先级

直播间配置 > 全局配置

### 示例

假设配置如下：

- 全局配置：转封装=开启，自动上传=开启
- 房间123456配置：转封装=关闭

当收到房间123456的Webhook时：

- 转封装：关闭（使用直播间配置）
- 自动上传：开启（直播间配置未设置，使用全局配置）

## 错误处理

### 参数错误

如果必需参数缺失或格式错误：

- 返回 HTTP 400
- 返回错误信息
- 不进入处理队列

### 文件不存在

如果 `filePath` 指向的文件不存在：

- 返回 HTTP 200（避免阻塞）
- 记录错误日志
- 不进入处理队列

### 处理失败

如果处理过程中发生错误：

- 标记任务失败
- 记录错误日志
- 发送失败通知（如果启用）
- 不影响其他任务

## Docker 环境

在 Docker 环境下使用 Webhook 需要注意：

### 网络配置

使用服务名而不是 localhost：

```
http://api:18010/webhook/bililiverecorder
```

而不是：

```
http://127.0.0.1:18010/webhook/bililiverecorder
```

### 卷映射

录播软件和 biliLive-tools 必须使用相同的卷映射：

```yaml
# 录播姬
volumes:
  - ./video:/rec

# biliLive-tools
volumes:
  - ./video:/app/video
```

### 路径转换

Docker 环境会自动处理路径转换，无需额外配置。

## 安全性

### 访问控制

默认只监听 `127.0.0.1`，只接受本地请求。

如果需要接受外部请求：

1. 修改监听地址为 `0.0.0.0`
2. 配置防火墙规则
3. 考虑使用反向代理
4. 添加身份验证

::: warning 安全提示
不建议将 Webhook 暴露在公网，存在安全风险。
:::

### 身份验证

目前不支持身份验证，计划在未来版本中添加。

### HTTPS

目前不支持 HTTPS，可以通过反向代理（如 Nginx）实现。

## 性能优化

### 队列管理

- 使用队列避免并发过多
- 可配置最大并发数
- 自动错误重试

### 资源限制

- CPU：可配置最大CPU使用率
- 内存：自动控制内存使用
- 磁盘：检查剩余空间

### 日志管理

- 自动清理旧日志
- 可配置日志级别
- 支持日志轮转

## 监控与调试

### 查看队列状态

在"队列"页面查看：

- 等待中的任务
- 正在处理的任务
- 已完成的任务
- 失败的任务

### 查看日志

点击任务查看详细日志：

- Webhook 接收时间
- 处理开始时间
- 各步骤耗时
- 错误信息

### 调试模式

开启调试模式可以看到更详细的日志：

1. 打开"设置" -> "高级设置"
2. 启用"调试模式"
3. 重启应用

## 最佳实践

### 1. 合理配置超时

- 短视频：短超时
- 长视频：长超时
- 大文件：增加超时

### 2. 错误处理

- 配置重试次数
- 配置重试间隔
- 启用失败通知

### 3. 资源管理

- 限制并发数
- 定期清理文件
- 监控磁盘空间

### 4. 日志管理

- 定期查看日志
- 及时处理错误
- 归档历史日志

## 故障排除

### Webhook 没有触发

1. 检查 Webhook 开关是否启用
2. 检查录播软件的 Webhook 配置
3. 检查端口是否正确
4. 查看应用日志

### 文件路径找不到

1. 检查路径是否为绝对路径
2. Docker 环境检查卷映射
3. 检查文件是否存在
4. 检查权限

### 处理失败

1. 查看详细日志
2. 检查配置是否正确
3. 检查依赖是否安装
4. 尝试手动处理

## 下一步

- [环境变量](./environment.md) - 配置环境变量
- [Webhook功能](../features/webhook.md) - Webhook 使用指南
- [开发指南](../development/guide.md) - 参与开发
